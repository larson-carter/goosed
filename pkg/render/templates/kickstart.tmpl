# Kickstart generated by goosed API
{{- $profile := .Profile -}}
{{- $kickstart := index $profile "kickstart" -}}
{{- $lang := "en_US.UTF-8" -}}
{{- if $profile }}
  {{- with index $profile "lang" }}{{ $lang = . }}{{ end }}
{{- end }}
{{- if $kickstart }}
  {{- with index $kickstart "lang" }}{{ $lang = . }}{{ end }}
{{- end }}
lang {{$lang}}

{{- $keyboard := "us" -}}
{{- if $profile }}
  {{- with index $profile "keyboard" }}{{ $keyboard = . }}{{ end }}
{{- end }}
{{- if $kickstart }}
  {{- with index $kickstart "keyboard" }}{{ $keyboard = . }}{{ end }}
{{- end }}
keyboard {{$keyboard}}

{{- $tz := "UTC" -}}
{{- $tzIsUTC := true -}}
{{- if $kickstart }}
  {{- with index $kickstart "timezone" }}{{ $tz = . }}{{ end }}
  {{- with index $kickstart "isUtc" }}{{ $tzIsUTC = . }}{{ end }}
{{- end }}
timezone {{$tz}}{{if $tzIsUTC}} --isUtc{{end}}

{{- $network := index $profile "network" -}}
{{- $hostname := index $profile "hostname" -}}
{{- $iface := "" -}}
{{- if $network }}
  {{- with index $network "interface" }}{{ $iface = . }}{{ end }}
{{- end }}
network --bootproto=dhcp{{if $iface}} --device={{$iface}}{{end}}{{if $hostname}} --hostname={{$hostname}}{{end}}

{{- with index $profile "install" }}
  {{- $method := index . "method" }}
  {{- if eq $method "cdrom" }}
cdrom
  {{- else if eq $method "nfs" }}
    {{- $server := index . "server" -}}
    {{- $path := index . "path" -}}
nfs{{if $server}} --server={{$server}}{{end}}{{if $path}} --dir={{$path}}{{end}}
  {{- else if index . "url" }}
url --url={{index . "url"}}
  {{- end }}
{{- end }}

{{- with index $profile "repos" }}
  {{- range $name, $value := . }}
repo --name={{$name}} --baseurl={{$value}}
  {{- end }}
{{- end }}

{{- if $kickstart }}
  {{- with index $kickstart "rootPasswordHash" }}
rootpw --iscrypted {{.}}
  {{- end }}
  {{- with index $kickstart "ntpServers" }}
    {{- range $server := . }}
timesource --ntp-server={{$server}}
    {{- end }}
  {{- end }}
  {{- with index $kickstart "users" }}
    {{- range $user := . }}
      {{- $username := index $user "name" -}}
      {{- if $username }}
user --name={{$username}}{{with index $user "groups"}} --groups={{.}}{{end}}{{with index $user "passwordHash"}} --password={{.}} --iscrypted{{end}}
        {{- with index $user "sshAuthorizedKeys" }}
          {{- range $key := . }}
sshkey --username={{$username}} "{{$key}}"
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

%packages
@^minimal
chrony
{{- with index $profile "packages" }}
  {{- range $pkg := . }}
{{$pkg}}
  {{- end }}
{{- end }}
%end

%post
set -eux

echo "Provisioned machine {{.Machine.ID}} (MAC {{.Machine.MAC}})" > /root/provisioned
{{- $agentURL := .AgentInstallURL -}}
{{- if not $agentURL -}}
  {{- $agentURL = printf "%s/v1/agents/rhel/install" .APIBase -}}
{{- end -}}
curl -fsSL {{$agentURL}} | bash -s -- --api {{ .APIBase }} --token {{ .Token }} --machine {{ .Machine.ID }}
%end
